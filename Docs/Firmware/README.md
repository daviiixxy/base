# ๐ข CoreHub - Sistema de Automaรงรฃo Inteligente

## ๐ รndice
- [Visรฃo Geral](#visรฃo-geral)
- [Arquitetura do Sistema](#arquitetura-do-sistema)
- [Fluxogramas](#fluxogramas)
- [Organogramas](#organogramas)
- [Componentes](#componentes)
- [Protocolos de Comunicaรงรฃo](#protocolos-de-comunicaรงรฃo)
- [Instalaรงรฃo e Configuraรงรฃo](#instalaรงรฃo-e-configuraรงรฃo)
- [API e Integraรงรฃo](#api-e-integraรงรฃo)
- [Troubleshooting](#troubleshooting)
- [Contribuiรงรฃo](#contribuiรงรฃo)

---

## ๐ฏ Visรฃo Geral

O **CoreHub** รฉ um sistema central de automaรงรฃo inteligente que integra mรบltiplos ambientes atravรฉs de comunicaรงรฃo MQTT via **NB-IoT**. O sistema gerencia dispositivos inteligentes como SmartDoor, SenseClima e AirControl, implementando lรณgica de controle automรกtico baseada em condiรงรตes ambientais e de seguranรงa.

### ๐ฏ Objetivos Principais
- **Automaรงรฃo Inteligente**: Controle automรกtico de ar condicionado baseado em temperatura
- **Seguranรงa**: Sistema de alarme com buzzer para portas abertas com luz acesa
- **Multi-Ambiente**: Gerenciamento simultรขneo de mรบltiplos ambientes
- **Comunicaรงรฃo NB-IoT**: Sistema MQTT robusto com conectividade celular de baixo consumo
- **Confiabilidade**: Retry automรกtico e reconexรฃo inteligente

---

## ๐๏ธ Arquitetura do Sistema

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        COREHUB SYSTEM                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                 โ
โ  โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโ โ
โ  โ   AMBIENTE 1    โ    โ   AMBIENTE 2    โ    โ  AMBIENTE 3  โ โ
โ  โ   "externo"     โ    โ   "mesanino"    โ    โ"prototipagem"โ โ
โ  โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโ โ
โ           โ                       โ                       โ     โ
โ           โโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ                                   โ                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ                    CLIENTE MQTT รNICO                       โโ
โ  โ  โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ โโ
โ  โ  โ   SmartDoor     โ  โ   SenseClima    โ  โ  AirControl  โ โโ
โ  โ  โ  - Door State   โ  โ  - Temperature  โ  โ  - Power     โ โโ
โ  โ  โ  - Light State  โ  โ  - Humidity     โ  โ  - Temp Set  โ โโ
โ  โ  โ  - Buzzer       โ  โ                 โ  โ              โ โโ
โ  โ  โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                   โ                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ                    MQTT BROKER                              โโ
โ  โ                131.255.82.115:1883                          โโ
โ  โ                    via NB-IoT                               โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Fluxogramas

### 1. Fluxograma Principal do CoreHub

```mermaid
flowchart TD
    A[Inรญcio] --> B[Inicializar Ambientes]
    B --> C[Conectar MQTT Broker]
    C --> D{Conectado?}
    D -->|Nรฃo| E[Tentar Reconectar]
    E --> C
    D -->|Sim| F[Inscrever em Tรณpicos]
    F --> G[Loop Principal]
    
    G --> H[Receber Mensagens MQTT]
    H --> I[Identificar Ambiente]
    I --> J[Processar Dados]
    J --> K[Executar FSM]
    K --> L[Publicar Comandos]
    L --> G
    
    G --> M{Verificar Conexรฃo}
    M -->|Perdida| N[Desconectar]
    N --> C
    M -->|OK| G
```

### 2. Fluxograma da FSM (Mรกquina de Estados)

```mermaid
stateDiagram-v2
    [*] --> INIT_STATE
    INIT_STATE --> CONNECT_MQTT_STATE
    CONNECT_MQTT_STATE --> IDLE_STATE : MQTT Conectado
    CONNECT_MQTT_STATE --> RECONNECT_STATE : MQTT Desconectado
    RECONNECT_STATE --> CONNECT_MQTT_STATE
    
    IDLE_STATE --> ANALYZE_DOOR_STATE : Evento Porta/Luz
    IDLE_STATE --> AC_ON_STATE : Temp > 28ยฐC
    IDLE_STATE --> AC_OFF_STATE : Temp < 24ยฐC
    
    ANALYZE_DOOR_STATE --> AC_ON_STATE : Luz ON + Porta FECHADA
    ANALYZE_DOOR_STATE --> AC_OFF_STATE : Luz OFF
    ANALYZE_DOOR_STATE --> ALARM_LOGIC_STATE : Luz ON + Porta ABERTA
    ANALYZE_DOOR_STATE --> IDLE_STATE : Outras condiรงรตes
    
    ALARM_LOGIC_STATE --> WAIT_TIMER_STATE : Condiรงรตes atendidas
    ALARM_LOGIC_STATE --> IDLE_STATE : Condiรงรตes nรฃo atendidas
    
    WAIT_TIMER_STATE --> BUZZER_ON_STATE : Timer esgotado (60s)
    WAIT_TIMER_STATE --> BUZZER_OFF_STATE : Porta fechou/Luz apagou
    WAIT_TIMER_STATE --> WAIT_TIMER_STATE : Timer rodando
    
    BUZZER_ON_STATE --> IDLE_STATE
    BUZZER_OFF_STATE --> ANALYZE_DOOR_STATE
    
    AC_ON_STATE --> IDLE_STATE
    AC_OFF_STATE --> IDLE_STATE
```

### 3. Fluxograma de Processamento de Mensagens

```mermaid
flowchart TD
    A[Mensagem MQTT Recebida] --> B[Extrair Tรณpico e Payload]
    B --> C[Identificar Ambiente]
    C --> D{Ambiente Vรกlido?}
    D -->|Nรฃo| E[Log Erro]
    D -->|Sim| F[Tipo de Mensagem?]
    
    F -->|SmartDoor/Door| G[Processar Estado da Porta]
    F -->|SmartDoor/Light| H[Processar Estado da Luz]
    F -->|SenseClima/Temp| I[Processar Temperatura]
    F -->|SenseClima/Humidity| J[Processar Umidade]
    F -->|AirControl/Power| K[Processar Estado do AC]
    
    G --> L[Atualizar corehub_data]
    H --> L
    I --> L
    J --> L
    K --> L
    
    L --> M[Transicionar FSM]
    M --> N[Executar Aรงรตes]
    N --> O[Publicar Comandos]
```

---

## ๐ Organogramas

### 1. Organograma de Tarefas FreeRTOS

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    FREE RTOS KERNEL                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ                 HT_CoreHubTask                              โโ
โ  โ              (Prioridade Normal)                            โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโ
โ  โ  โ              Inicializaรงรฃo                          โ    โโ
โ  โ  โ  โข Aguardar SIM Ready                               โ    โโ
โ  โ  โ  โข Configurar Rede NB-IoT                           โ    โโ
โ  โ  โ  โข Inicializar Ambientes                            โ    โโ
โ  โ  โ  โข Criar Task MQTT Global                           โ    โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                   โ                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ              HT_CoreHub_MqttTask                            โโ
โ  โ           (Prioridade Mรกxima)                               โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโ
โ  โ  โ              Processamento MQTT                     โ    โโ
โ  โ  โ  โข Conexรฃo MQTT Broker                              โ    โโ
โ  โ  โ  โข Subscribe em Tรณpicos                             โ    โโ
โ  โ  โ  โข Receber Mensagens                                โ    โโ
โ  โ  โ  โข Executar FSM para todos os ambientes             โ    โโ
โ  โ  โ  โข Publicar Comandos                                โ    โโ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 2. Organograma de Estruturas de Dados

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ESTRUTURAS DE DADOS                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ              CoreHub_Data_t [NUM_AMBIENTES]                โ โ
โ  โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ  โ Ambiente 0  โ  โ Ambiente 1  โ  โ    Ambiente 2       โ โ โ
โ  โ  โ "externo"   โ  โ "mesanino"  โ  โ  "prototipagem"     โ โ โ
โ  โ  โ             โ  โ             โ  โ                     โ โ โ
โ  โ  โ โข temp      โ  โ โข temp      โ  โ  โข temp             โ โ โ
โ  โ  โ โข humidity  โ  โ โข humidity  โ  โ  โข humidity         โ โ โ
โ  โ  โ โข door      โ  โ โข door      โ  โ  โข door             โ โ โ
โ  โ  โ โข light     โ  โ โข light     โ  โ  โข light            โ โ โ
โ  โ  โ โข ac        โ  โ โข ac        โ  โ  โข ac               โ โ โ
โ  โ  โ โข buzzer    โ  โ โข buzzer    โ  โ  โข buzzer           โ โ โ
โ  โ  โ โข alarm     โ  โ โข alarm     โ  โ  โข alarm            โ โ โ
โ  โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                   โ                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ              current_state [NUM_AMBIENTES]                 โ โ
โ  โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ  โ Estado 0    โ  โ Estado 1    โ  โ    Estado 2         โ โ โ
โ  โ  โ IDLE_STATE  โ  โ IDLE_STATE  โ  โ  IDLE_STATE         โ โ โ
โ  โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                   โ                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ              Tรณpicos MQTT [NUM_AMBIENTES]                  โ โ
โ  โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ  โ Topics 0    โ  โ Topics 1    โ  โ    Topics 2         โ โ โ
โ  โ  โ โข door      โ  โ โข door      โ  โ  โข door             โ โ โ
โ  โ  โ โข light     โ  โ โข light     โ  โ  โข light            โ โ โ
โ  โ  โ โข buzzer    โ  โ โข buzzer    โ  โ  โข buzzer           โ โ โ
โ  โ  โ โข temp      โ  โ โข temp      โ  โ  โข temp             โ โ โ
โ  โ  โ โข humidity  โ  โ โข humidity  โ  โ  โข humidity         โ โ โ
โ  โ  โ โข ac_power  โ  โ โข ac_power  โ  โ  โข ac_power         โ โ โ
โ  โ  โ โข ac_temp   โ  โ โข ac_temp   โ  โ  โข ac_temp          โ โ โ
โ  โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ง Componentes

### 1. SmartDoor
- **Funรงรฃo**: Controle de porta e iluminaรงรฃo
- **Tรณpicos**:
  - `hana/{ambiente}/smartdoor/door` โ `OPEN/CLOSED`
  - `hana/{ambiente}/smartdoor/light` โ `ON/OFF`
  - `hana/{ambiente}/smartdoor/buzzer` โ `ON/OFF`

### 2. SenseClima
- **Funรงรฃo**: Monitoramento ambiental
- **Tรณpicos**:
  - `hana/{ambiente}/senseclima/01/temperature` โ `float`
  - `hana/{ambiente}/senseclima/01/humidity` โ `float`

### 3. AirControl
- **Funรงรฃo**: Controle de ar condicionado
- **Tรณpicos**:
  - `hana/{ambiente}/aircontrol/01/power` โ `ON/OFF`
  - `hana/{ambiente}/aircontrol/01/temperature` โ `int`

---

## ๐ก Protocolos de Comunicaรงรฃo

### ๐ฐ๏ธ Tecnologia NB-IoT

O CoreHub utiliza **NB-IoT (Narrowband Internet of Things)** como tecnologia de comunicaรงรฃo, oferecendo:

- **Baixo Consumo**: Otimizado para dispositivos IoT de longa duraรงรฃo
- **Cobertura Estendida**: Melhor penetraรงรฃo em ambientes fechados
- **Custo Reduzido**: Tarifaรงรฃo baseada em volume de dados
- **Confiabilidade**: Rede celular robusta e estรกvel
- **Seguranรงa**: Comunicaรงรฃo criptografada via rede mรณvel

#### Configuraรงรตes NB-IoT
```c
// Configuraรงรตes de Rede
#define NETWORK_MODE NB_IOT_MODE
#define BAND_NUMBER 1
#define BAND_FREQUENCY 28
#define APN "iot.datatem.com.br"

// Configuraรงรตes de Energia
#define PSM_MODE 1
#define TAU_TIME 4000
#define ACTIVE_TIME 30
```

### MQTT Configuration via NB-IoT
```c
// Broker Settings
#define BROKER_ADDR "131.255.82.115"
#define BROKER_PORT 1883
#define CLIENT_ID "corehub01"
#define KEEP_ALIVE 240

// NB-IoT Settings
#define NETWORK_MODE NB_IOT_MODE
#define BAND_NUMBER 1
#define BAND_FREQUENCY 28
#define APN "iot.datatem.com.br"
```

// QoS Levels
#define QOS_LEVEL QOS0  // At most once delivery

// Buffer Sizes
#define MQTT_BUFFER_SIZE 1024
#define SEND_TIMEOUT 60000
#define RECEIVE_TIMEOUT 60000
```

### Topic Structure
```
hana/
โโโ {ambiente}/
โ   โโโ smartdoor/
โ   โ   โโโ door
โ   โ   โโโ light
โ   โ   โโโ buzzer
โ   โโโ senseclima/
โ   โ   โโโ 01/
โ   โ       โโโ temperature
โ   โ       โโโ humidity
โ   โโโ aircontrol/
โ       โโโ 01/
โ           โโโ power
โ           โโโ temperature
```

---

## โ๏ธ Instalaรงรฃo e Configuraรงรฃo

### Prรฉ-requisitos
- Compilador ARM GCC
- FreeRTOS
- MQTT Client Library
- HTNB32L SDK
- SIM Card NB-IoT
- Cobertura de rede celular

### Compilaรงรฃo
```bash
# Compilar o projeto
make -j4 gccall TARGET=qcx212_0h00 V=0 PROJECT=Template

# Flash para dispositivo
make flash TARGET=qcx212_0h00 PROJECT=Template
```

### Configuraรงรฃo de Ambientes
```c
// Definir ambientes no main.c
const char* ambientes[NUM_AMBIENTES] = {
    "externo",      // Ambiente 0
    "mesanino",     // Ambiente 1
    "prototipagem"  // Ambiente 2
};
```

---

## ๐ API e Integraรงรฃo

### Funรงรตes Principais

#### Inicializaรงรฃo
```c
// Inicializar ambiente especรญfico
void HT_CoreHub_InitAmbiente(int ambiente_idx, const char* nome);

// Iniciar task MQTT global
void HT_CoreHub_MqttTask(void *pvParameters);
```

#### Estados da FSM
```c
typedef enum {
    COREHUB_INIT_STATE = 0,
    COREHUB_CONNECT_MQTT_STATE,
    COREHUB_IDLE_STATE,
    COREHUB_RECONNECT_STATE,
    COREHUB_ANALYZE_DOOR_STATE,
    COREHUB_ANALYZE_TEMP_STATE,
    COREHUB_AC_ON_STATE,
    COREHUB_AC_OFF_STATE,
    COREHUB_ALARM_LOGIC_STATE,
    COREHUB_WAIT_TIMER_STATE,
    COREHUB_BUZZER_ON_STATE,
    COREHUB_BUZZER_OFF_STATE
} CoreHub_FSM_States;
```

### Configuraรงรตes
```c
// Limites de temperatura
#define HT_COREHUB_TEMP_LIMIT_UPPER 28.0f
#define HT_COREHUB_TEMP_LIMIT_LOWER 24.0f

// Timeout do alarme
#define HT_COREHUB_ALARM_TIMEOUT_MS 60000

// Setpoint do AC
#define HT_COREHUB_AC_TEMP_SETPOINT 22
```

---

## ๐ Troubleshooting

### Problemas Comuns

#### 1. Conexรฃo MQTT Falha
```
[ERRO] Falha na conexรฃo MQTT (erro: -1)
```
**Soluรงรฃo**: Verificar conectividade de rede e configuraรงรตes do broker

#### 2. Ambiente Nรฃo Identificado
```
[ERRO] Ambiente nรฃo identificado para tรณpico: hana/test/door
```
**Soluรงรฃo**: Verificar se o ambiente estรก na lista `ambientes[]`

#### 3. Buffer Overflow
```
[ERRO] Buffer overflow no tรณpico MQTT
```
**Soluรงรฃo**: Aumentar `HT_COREHUB_MQTT_BUFFER_SIZE`

### Logs de Debug
```c
// Habilitar logs detalhados
printf("CoreHub[%s] - DEBUG: %s\n", ambientes[ambiente_idx], message);

// Logs de estado da FSM
printf("CoreHub - FSM: %s\n", state_name);
```

---

## ๐ค Contribuiรงรฃo

### Estrutura do Projeto
```
Firmware/
โโโ Applications/
โ   โโโ Template/
โ       โโโ Inc/
โ       โ   โโโ HT_CoreHubFsm.h
โ       โ   โโโ CoreHub_Config.h
โ       โโโ Src/
โ           โโโ main.c
โ           โโโ HT_CoreHubFsm.c
โ           โโโ HT_MQTT_Api.c
โโโ SDK/
โ   โโโ Thirdparty/
โ       โโโ MQTT/
โโโ Build/
```

### Padrรตes de Cรณdigo
- **Nomenclatura**: Prefixo `HT_` para funรงรตes pรบblicas
- **Comentรกrios**: Documentaรงรฃo em portuguรชs
- **Logs**: Formato `CoreHub[ambiente] - mensagem`
- **Estados**: Enum com prefixo `COREHUB_`

### Testes
```bash
# Teste de compilaรงรฃo
make clean && make all

# Teste de conectividade MQTT
# Usar ferramentas como MQTT Explorer
```

---

## ๐ Licenรงa

Este projeto estรก licenciado sob a Apache License 2.0.

---

## ๐ Suporte

Para suporte tรฉcnico ou dรบvidas:
- **Email**: suporte@corehub.com
- **Documentaรงรฃo**: [Wiki do Projeto](https://github.com/corehub/wiki)
- **Issues**: [GitHub Issues](https://github.com/corehub/issues)

---

*Documentaรงรฃo gerada automaticamente - CoreHub v1.0* 